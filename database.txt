
-- --- MISE A JOUR DU TRIGGER (POUR LE PAYS) ---
-- Exécutez ce script pour que le pays choisi à l'inscription soit bien sauvegardé.

create or replace function public.handle_new_user()
returns trigger 
security definer 
set search_path = public
as $$
declare
  final_username text;
  user_full_name text;
  user_country text;
begin
  -- Nom d'utilisateur basé sur l'ID (Collision impossible)
  final_username := 'user_' || substr(new.id::text, 1, 8);
  
  -- Récupération des données envoyées depuis le formulaire (AuthModal)
  -- Si pas de nom fourni, on prend la partie avant @ de l'email
  user_full_name := coalesce(new.raw_user_meta_data->>'full_name', split_part(new.email, '@', 1));
  
  -- Si pas de pays fourni, on met 'CD' (Congo) par défaut, ou 'XY' pour inconnu
  user_country := coalesce(new.raw_user_meta_data->>'country', 'CD');

  insert into public.profiles (id, username, full_name, email, role, elo_rapid, country, created_at)
  values (
    new.id, 
    final_username,
    user_full_name, 
    new.email,
    'member', -- Tout le monde commence comme 'member'. Changez manuellement en 'admin' dans Supabase pour tester.
    1200,
    user_country,
    now()
  );

  return new;
end;
$$ language plpgsql;
