
-- --- RESET TOTAL ET PROPRE ---
-- Ce script supprime toutes les tables et les recrée pour garantir qu'aucune donnée corrompue ne reste.

-- 1. DESACTIVATION DES TRIGGERS
drop trigger if exists on_auth_user_created on auth.users;
drop function if exists public.handle_new_user();

-- 2. SUPPRESSION EN CASCADE (Nettoyage radical)
drop table if exists public.games cascade;
drop table if exists public.tournament_registrations cascade;
drop table if exists public.tournaments cascade;
drop table if exists public.announcements cascade;
drop table if exists public.messages cascade;
drop table if exists public.app_settings cascade;
drop table if exists public.profiles cascade;
drop table if exists public.clubs cascade;

-- 3. RECREATION DES EXTENSIONS
create extension if not exists "uuid-ossp";

-- 4. RECREATION DES TABLES

-- Clubs
create table public.clubs (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  description text,
  logo_url text,
  city text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Profiles (Lié à auth.users)
create table public.profiles (
  id uuid not null primary key,
  username text unique not null,
  full_name text,
  email text,
  elo_rapid integer default 1200,
  elo_blitz integer default 1200,
  avatar_url text,
  bio text,
  club_id uuid references public.clubs(id),
  role text default 'member' check (role in ('member', 'admin', 'superadmin')),
  country text default 'CD',
  birth_year integer,
  gender text check (gender in ('M', 'F', 'Other')),
  tournaments_won integer default 0,
  is_paid_member boolean default false,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  constraint profiles_id_fkey foreign key (id) references auth.users(id) on delete cascade
);

-- Tournaments
create table public.tournaments (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  description text,
  start_date timestamp with time zone not null,
  end_date timestamp with time zone,
  type text default 'swiss',
  category text default 'open',
  status text default 'planned',
  organizer_id uuid references public.profiles(id),
  winning_club_id uuid references public.clubs(id),
  registered_count integer default 0,
  max_players integer default 100,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Registrations
create table public.tournament_registrations (
  id uuid default uuid_generate_v4() primary key,
  tournament_id uuid references public.tournaments(id) not null,
  player_id uuid references public.profiles(id) not null,
  status text default 'pending',
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(tournament_id, player_id)
);

-- Games
create table public.games (
  id uuid default uuid_generate_v4() primary key,
  white_player_id uuid references public.profiles(id),
  black_player_id uuid references public.profiles(id),
  pgn text,
  current_fen text default 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
  last_move_from text,
  last_move_to text,
  turn text default 'w',
  result text,
  status text default 'waiting', -- 'waiting', 'ongoing', 'finished'
  time_control integer not null,
  winner_id uuid references public.profiles(id),
  tournament_id uuid references public.tournaments(id),
  played_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 5. TRIGGER ULTRA ROBUSTE (Bypass RLS)
create or replace function public.handle_new_user()
returns trigger 
security definer 
set search_path = public
as $$
declare
  final_username text;
  user_full_name text;
  user_country text;
begin
  final_username := 'user_' || substr(new.id::text, 1, 8);
  user_full_name := coalesce(new.raw_user_meta_data->>'full_name', split_part(new.email, '@', 1));
  user_country := coalesce(new.raw_user_meta_data->>'country', 'CD');

  insert into public.profiles (id, username, full_name, email, role, elo_rapid, country, created_at)
  values (
    new.id, 
    final_username,
    user_full_name, 
    new.email,
    'member',
    1200,
    user_country,
    now()
  );
  return new;
end;
$$ language plpgsql;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- 6. PERMISSIONS & SECURITE (RLS)
alter table profiles enable row level security;
alter table games enable row level security;

-- Accorder les droits explicites
grant usage on schema public to postgres, anon, authenticated, service_role;
grant all on all tables in schema public to postgres, service_role;
grant all on all functions in schema public to postgres, service_role;
grant all on all sequences in schema public to postgres, service_role;

-- POLICIES PROFILES
create policy "Public profiles are viewable by everyone" on profiles for select using (true);
create policy "Users can update own profile" on profiles for update using (auth.uid() = id);

-- POLICIES GAMES (CRITIQUE POUR LE JEU EN LIGNE)
create policy "Anyone can read games" on games for select using (true);

create policy "Auth users can create games" on games for insert with check (auth.uid() = white_player_id);

-- IMPORTANT: Cette politique permet à un joueur de REJOINDRE une partie (update black_player_id) si elle est en attente
create policy "Users can join waiting games" on games for update 
using (
  status = 'waiting' 
  AND black_player_id IS NULL 
  AND auth.uid() != white_player_id
);

-- IMPORTANT: Cette politique permet aux joueurs DANS la partie de jouer (mettre à jour le FEN, etc)
create policy "Players can play their games" on games for update
using (
  (auth.uid() = white_player_id OR auth.uid() = black_player_id)
  AND status = 'ongoing'
);

-- 7. INSERTION DONNEES DE DEMARRAGE
insert into clubs (name, city, description) values 
('Royal Knights', 'London', 'Historical club.'),
('Global Gambit', 'Online', 'Online community.'),
('Paris Strategy', 'Paris', 'Tactical training.');
