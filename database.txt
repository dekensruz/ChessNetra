
-- --- SCHÃ‰MA CHESSNETRA FINAL ---

-- 1. EXTENSIONS
create extension if not exists "uuid-ossp";

-- 2. TABLES & PROFILS
create table public.profiles (
  id uuid not null primary key references auth.users(id) on delete cascade,
  username text unique not null,
  full_name text,
  email text,
  elo_rapid integer default 1200,
  role text default 'member' check (role in ('member', 'admin', 'superadmin')),
  country text default 'CD',
  bio text,
  avatar_url text,
  last_seen_at timestamp with time zone default now(),
  created_at timestamp with time zone default now()
);

-- 3. TOURNOIS
create table public.tournaments (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  description text,
  start_date timestamp with time zone not null,
  end_date timestamp with time zone,
  category text default 'open',
  status text default 'planned' check (status in ('planned', 'live', 'finished')),
  organizer_id uuid references public.profiles(id),
  registered_count integer default 0,
  max_players integer default 100,
  created_at timestamp with time zone default now()
);

-- 4. VUES
create or replace view tournaments_with_organizer_view as
select 
    t.*,
    p.username as organizer_username,
    p.full_name as organizer_full_name,
    p.avatar_url as organizer_avatar
from tournaments t
left join profiles p on t.organizer_id = p.id;

-- 5. STORAGE BUCKET (SQL)
-- insert into storage.buckets (id, name, public) values ('avatars', 'avatars', true);
-- create policy "Avatar upload policy" on storage.objects for insert with check (bucket_id = 'avatars');
-- create policy "Avatar view policy" on storage.objects for select using (bucket_id = 'avatars');
