-- Enable UUID extension
create extension if not exists "uuid-ossp";

-- 1. CLUBS
create table public.clubs (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  description text,
  logo_url text,
  city text not null, -- e.g., New York, Paris, Online
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. PROFILES (Extends Supabase Auth)
create table public.profiles (
  id uuid references auth.users not null primary key,
  username text unique not null,
  full_name text,
  elo_rapid integer default 1200,
  elo_blitz integer default 1200,
  avatar_url text,
  bio text,
  club_id uuid references public.clubs(id),
  role text default 'member' check (role in ('member', 'admin', 'superadmin')),
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. TOURNAMENTS
create table public.tournaments (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  description text,
  start_date timestamp with time zone not null,
  type text default 'swiss' check (type in ('swiss', 'arena', 'knockout')),
  status text default 'planned' check (status in ('planned', 'live', 'finished')),
  organizer_id uuid references public.profiles(id),
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. GAMES
create table public.games (
  id uuid default uuid_generate_v4() primary key,
  white_player_id uuid references public.profiles(id),
  black_player_id uuid references public.profiles(id),
  pgn text, -- Portable Game Notation
  fen text, -- Current board state
  result text check (result in ('white', 'black', 'draw', 'ongoing')),
  time_control text not null, -- e.g., "10+5"
  tournament_id uuid references public.tournaments(id),
  played_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 5. ANNOUNCEMENTS
create table public.announcements (
  id uuid default uuid_generate_v4() primary key,
  title text not null,
  content text not null,
  category text check (category in ('info', 'tournament', 'training', 'club')),
  is_pinned boolean default false,
  author_id uuid references public.profiles(id),
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 6. MESSAGES (Chat)
create table public.messages (
  id uuid default uuid_generate_v4() primary key,
  content text not null,
  sender_id uuid references public.profiles(id) not null,
  room_id text default 'general', -- Can be a club ID or 'general'
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- ROW LEVEL SECURITY (RLS) POLICIES (Basic Examples)
alter table profiles enable row level security;
alter table games enable row level security;

create policy "Public profiles are viewable by everyone" on profiles for select using (true);
create policy "Users can update own profile" on profiles for update using (auth.uid() = id);

-- Insert Dummy Data (International Context)
insert into clubs (name, city, description) values 
('Royal Knights', 'London', 'Historical club with grandmaster traditions.'),
('Global Gambit', 'Online', 'The largest online chess community.'),
('Paris Strategy', 'Paris', 'Excellence in tactical training.');