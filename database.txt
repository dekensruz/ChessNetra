
-- Enable UUID extension
create extension if not exists "uuid-ossp";

-- 1. CLUBS
create table public.clubs (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  description text,
  logo_url text,
  city text not null, -- e.g., New York, Paris, Online
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. PROFILES (Extends Supabase Auth)
create table public.profiles (
  id uuid references auth.users not null primary key,
  username text unique not null,
  full_name text,
  elo_rapid integer default 1200,
  elo_blitz integer default 1200,
  avatar_url text,
  bio text,
  club_id uuid references public.clubs(id),
  role text default 'member' check (role in ('member', 'admin', 'superadmin')),
  
  -- Nouveaux champs pour les filtres de classement
  country text default 'CD',
  birth_year integer,
  gender text check (gender in ('M', 'F', 'Other')),
  tournaments_won integer default 0,
  is_paid_member boolean default false, -- Statut financier vis-Ã -vis du club
  
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. TOURNAMENTS
create table public.tournaments (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  description text,
  start_date timestamp with time zone not null,
  end_date timestamp with time zone, -- Ajout date de fin pour le minuteur
  type text default 'swiss' check (type in ('swiss', 'arena', 'knockout')),
  category text default 'open' check (category in ('open', 'validation')), -- Open ou Validation Admin
  status text default 'planned' check (status in ('planned', 'live', 'finished')),
  organizer_id uuid references public.profiles(id),
  winning_club_id uuid references public.clubs(id),
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. TOURNAMENT REGISTRATIONS (Nouveau)
create table public.tournament_registrations (
  id uuid default uuid_generate_v4() primary key,
  tournament_id uuid references public.tournaments(id) not null,
  player_id uuid references public.profiles(id) not null,
  status text default 'pending' check (status in ('pending', 'approved', 'rejected')),
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(tournament_id, player_id)
);

-- 5. APP SETTINGS (Nouveau - Pour le bouton Super Admin)
create table public.app_settings (
  key text primary key,
  value boolean default false,
  updated_by uuid references public.profiles(id),
  updated_at timestamp with time zone default timezone('utc'::text, now())
);
-- Initial value: insert into public.app_settings (key, value) values ('allow_unpaid_tournaments', false);

-- 6. GAMES
create table public.games (
  id uuid default uuid_generate_v4() primary key,
  white_player_id uuid references public.profiles(id),
  black_player_id uuid references public.profiles(id),
  pgn text, -- Portable Game Notation
  fen text, -- Current board state
  result text check (result in ('white', 'black', 'draw', 'ongoing')),
  time_control text not null, -- e.g., "10+5"
  tournament_id uuid references public.tournaments(id),
  played_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 7. ANNOUNCEMENTS
create table public.announcements (
  id uuid default uuid_generate_v4() primary key,
  title text not null,
  content text not null,
  category text check (category in ('info', 'tournament', 'training', 'club')),
  is_pinned boolean default false,
  author_id uuid references public.profiles(id),
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 8. MESSAGES (Chat)
create table public.messages (
  id uuid default uuid_generate_v4() primary key,
  content text not null,
  sender_id uuid references public.profiles(id) not null,
  room_id text default 'general', -- Can be a club ID or 'general'
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- ROW LEVEL SECURITY (RLS) POLICIES
alter table profiles enable row level security;
alter table games enable row level security;
alter table app_settings enable row level security;

create policy "Public profiles are viewable by everyone" on profiles for select using (true);
create policy "Users can update own profile" on profiles for update using (auth.uid() = id);
create policy "Read settings" on app_settings for select using (true);

-- Insert Dummy Data (International Context)
insert into clubs (name, city, description) values 
('Royal Knights', 'London', 'Historical club with grandmaster traditions.'),
('Global Gambit', 'Online', 'The largest online chess community.'),
('Paris Strategy', 'Paris', 'Excellence in tactical training.');
